<style>
    .instalador {
        background-color: #e3e3e3;
        justify-content: center;
        display: flex;
        position: relative;
        margin: auto;
        padding: 5px;
        max-width: 60px;
        border-radius: 30px;
    }

    #header {
        width: 100%;
        border-bottom: rgb(40, 55, 86) 0, 1px solid;
        color: rgb(40, 55, 86);
    }

    .filtro-selecao {
        width: fit-content;
        height: fit-content;
        background: white;
        border: solid 1px;
        border-radius: 10px;
        margin-left: 5px;
    }

    table {
        width: 100%;
    }

    th {
        text-align: center;
    }

    tr {
        font-size: 12px;
        border-bottom: rgba(120, 120, 120, 0.4) solid 1px;
    }

    a {
        text-decoration: none;
        color: rgb(40, 55, 86);
    }
</style>
<script>
    window.onload = function () {
        var dataini = document.getElementById('dataini')
        var datafim = document.getElementById('datafim')
        if (dataini.value == '') {
            var data = new Date()
            var mes = data.getMonth()
            var ano = data.getFullYear()
            if (mes == 0 || mes == 2 || mes == 4 || mes == 6 || mes == 7 || mes == 9 || mes == 11) {
                dia = '31'
            } else {
                dia = '30'
            }
            mes = mes + 1
            dataini.value = ano + '-' + mes + '-' + '01'
            datafim.value = ano + '-' + mes + '-' + dia
        }
    }
</script>
<div class='row' style="width: 100%;padding-left: 2%;">
    <label class="titulo-inicio">Lista de Obras em Operação</label>
    {{!-- <div id='header'>
        <div class="row mt-2">
            <ul class="nav nav-tabs mb-2">
                <li class="nav-item">
                    <a class="nav-link active" aria-current="page" style="color: black"
                        href="/gerenciamento/emandamento/lista">

                    </a>
                </li>
                <li class="nav-item">
                    <a class="nav-link" aria-current="page" style="color: black"
                        href="/gerenciamento/emandamento/agenda">
                        <label class="titulo-inicio">Agenda</label>
                    </a>
                </li>
            </ul>
        </div>
    </div> --}}
    <form action='/gerenciamento/emandamento/' method='post' class="no-print">
        <input type='hidden' name='tipo' value='emandamento'>
        <div class='row'>
            <div class='col'>
                <label class='col-form-label col-form-label-sm fw-bold'>Instalador</label>
                <select name='instalador' class='form-select form-select-sm'>
                    {{#if installer_name}}
                    <option class='fw-bold' value="{{installer_id}}">{{installer_name}}</option>
                    {{/if}}
                    <option>Todos</option>
                    {{#each todos_instaladores}}
                    <option value='{{_id}}'>{{nome}}</option>
                    {{else}}
                    <option>Nenhum instalador cadastrado</option>
                    {{/each}}
                </select>
            </div>
            <div class='col-md-3'>
                <label class='col-form-label col-form-label-sm fw-bold'>Status</label>
                <select name='stats' class='form-select form-select-sm'>
                    {{#if status}}
                    <option class='fw-bold' value="{{status}}">{{status}}</option>
                    {{/if}}
                    <option>Todos</option>
                    <option value='Aguardando'>Aguardando</option>
                    <option value='Execução'>Execução</option>
                    <option value='Instalado'>Instalado</option>
                    <option value='Parado'>Parado</option>
                </select>
            </div>
            <div style="width: 160px;">
                <label class="col-form-label col-form-label-sm">Data Inicial</label>
                <input type='date' class='form-control form-control-sm' name='dataini' id='dataini' value='{{dataini}}'>
            </div>
            <div style="width: 160px;">
                <label class="col-form-label col-form-label-sm">Data Final</label>
                <input type='date' class='form-control form-control-sm' name='datafim' id='datafim' value='{{datafim}}'>
            </div>
            <div style="width: 70px;">
                <button type='submit' class='mt-3 botaofiltrar'><i class='bi bi-search iconefiltrar'
                        style="display: flex;"></i></button>
            </div>
            <div style='width: 70px;' class="mt-3">
                <a href='/' class='no-print mt-4' style="color: rgb(40, 55, 86)" value="Imprimir"
                    onclick="window.print();return false"><i class="bi bi-printer"></i></a>
            </div>

        </div>
    </form>
    <div style="margin-bottom: 4%;margin-top: 1%;">

        <table>
            <tr>
            <tr>
                <th style="width: 2%;" rowspan="2">Cód.</th>
                <th style="width: 30%" rowspan="2">Cliente</th>
                <th style="width: 10%;" rowspan="2">Cidade</th>
                <th style="width: 10%;" rowspan="2">Telhado</th>
                <th style="width: 10%;" colspan="2">Módulos</th>
                <th style="width: 8%;" rowspan="2">Inversor</th>
                <th style="width: 10%;" rowspan="2">Instalador</th>
                <th style="width: 5%;" rowspan="2">Banco</th>
                <th style="width: 10%;" rowspan="2">Projeto</th>
                <th style="width: 15%;" rowspan="2">Pagamento</th>
                <th style="width: 10%" rowspan="2">Data Final</th>
            </tr>
            <tr>
                <th style="width: 8%;">Quantidade</th>
                <th style="width: 8%;">Potência</th>
            </tr>
            {{#each listaAndamento}}
            <tr style="line-height: 30px;">
                <td style="text-align: center;font-weight: 800;" {{#if parado}}id="parado" {{else}}{{#if
                    instalado}}id="execucao" {{else}}{{#if execucao}}id="realizado" {{else}}id="aguardando"
                    {{/if}}{{/if}}{{/if}}><a href='/gerenciamento/projeto/{{id}}'>{{seq}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{cliente}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{cidade}}/{{uf}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{telhado}}/{{estrutura}}</a>
                </td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{modulos}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{potencia}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{inversor}}</a></td>
                <td style="text-align: center;">
                    <button class='btn'
                        onclick='getInstaler("projeto{{seq}}","{{id}}","{{modulos}}","{{execucao}}","{{parado}}","{{instalado}}","{{autorizado}}","{{pago}}","{{encerrado}}")'
                        id='submit' data-bs-toggle="modal" data-bs-target="#instalador">
                        <i class='bi bi-person instalador'></i>
                        <div id='projeto{{seq}}' style="display: none;">
                            {{#each addInstalador}}
                            <label class="selectInstalador">{{instalador}}</label>
                            <label>/</label>
                            <label class="qtdmod">{{qtdmod}}</label>
                            {{/each}}
                        </div>
                    </button>
                </td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{inst_banco}}</a></td>
                <td style="text-align: center;">
                    <i {{#if autorizado}}class="bi bi-check" id='execucao' {{else}}class="bi bi-stop-fill" id='parado'
                        {{/if}} style="display: flex;justify-content: center;margin: auto;padding-top: 10px;"></i>
                </td>
                <td style="text-align: center;">
                    <i {{#if pagamento}}class="bi bi-check" id='execucao' {{else}}class="bi bi-stop-fill" id='parado'
                        {{/if}} style="display: flex;justify-content: center;margin: auto;padding-top: 10px;"></i>
                </td>
                <td style="text-align: center;">{{deadline}}</td>
            </tr>
            {{/each}}
        </table>
        {{!-- <table>
            <tr>
                <th style="width: 2%;" rowspan="2">Projeto</th>
                <th style="width: 10%;" rowspan="2">Instalador</th>
                <th style="width: 6%" rowspan="2">Inicio Programado</th>
                <th style="width: 6%" rowspan="2">Fim Programado</th>
                <th style="width: 10%;" rowspan="2">Cliente</th>
                <th style="width: 10%;" colspan="2">Módulos</th>
                <th style="width: 5%;" rowspan="2">Inversor</th>
                <th style="width: 10%;" rowspan="2">Telhado</th>
                <th style="width: 10%;" rowspan="2">Cidade</th>
                <th style="width: 5%" rowspan="2">Vendedor</th>
            </tr>
            <tr>
                <th style="width: 10%;">Quantidade</th>
                <th style="width: 10%;">Potência</th>
            </tr>
            {{#each listaAndamento}}
            <tr style="line-height: 30px;">
                <td style="text-align: center;font-weight: 800;" {{#if parado}}id="parado" {{else}}id="aguardando"
                    {{/if}}><a href='/gerenciamento/projeto/{{id}}'>{{seq}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{tecnico}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{dtinicio}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{deadline}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{cliente}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{modulos}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{potencia}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{inversor}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{telhado}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{cidade}}/{{uf}}</a></td>
                <td style="text-align: center;"><a href='/gerenciamento/projeto/{{id}}'>{{vendedor}}</a></td>
            </tr>
            {{else}}
            <h6>Nenhum projeto encontrado.</h6>
            {{/each}}
        </table> --}}
    </div>
</div>
<script type="text/javascript">

    function getInstaler(projeto, id, modulos, execucao, parado, instalado, autorizado, pago, encerrado) {
        const listInstallers = $("#modal-body-installers")
        const listModules = $("#modal-body-modules")
        const listActions = $("#modal-body-actions")
        const addInstaller = $("#addInstaller")
        const sendTeam = $("#sendTeam")
        const buttonAuth = $("#buttonAuth")
        const iconAuth = $("#iconAuth")

        const qtmod = document.getElementById('qtdmod')
        qtdmod.value = modulos

        const content = document.getElementById(projeto)
        const lengthInstal = content.getElementsByClassName('selectInstalador')
        const lengthQtdMod = content.getElementsByClassName('qtdmod')

        var instalers = ''
        var modules = ''
        var actions = ''
        for (i = 0; i < lengthInstal.length; i++) {
            instalers = instalers + lengthInstal[i].innerHTML + '<br>'
            modules = modules + lengthQtdMod[i].innerHTML + '<br>'
            actions = actions + '<div style="display: flex;">' +
                '<a href="/gerenciamento/removeAddInstalador/' + id + '@' + lengthInstal[i].innerHTML + '">' +
                '<i class="bi bi-trash2" style="display: flex; top: 3px;position: relative;margin:auto; justify-content: center; font-size: 20px"></i></a>' +
                '<div class="form-check">' +
                '<label class="check-label" style="width: 50px;">É banco?</label>' +
                '<input onclick="window.location.href="/gerenciamento/saveBank/' + id + '" class="check-input" type="checkbox" name="ehbanco">' +
                '</div></div>'
        }

        if (lengthInstal.length > 0) {
            sendTeam.show()
            const icon = document.createElement('icon')
            if (execucao == "true") {
                if (parado == "true") {
                    iconAuth.addClass("d-flex justify-align-right bi bi-arrow-right-circle")
                } else {
                    iconAuth.addClass("d-flex justify-align-right bi bi-stop-circle")
                }
            } else {
                iconAuth.addClass("d-flex justify-align-right bi bi-arrow-right-circle")
            }

            if (execucao == 'true') {
                if (parado == 'true') {
                    buttonAuth.addClass("d-flex justify-content-center btn btn-sm btn-primary")
                    buttonAuth.text("Autorizar Projeto")
                } else {
                    buttonAuth.addClass("d-flex justify-content-center btn bt-sm btn-warning")
                    buttonAuth.text("Parar Projeto")
                }
            } else {
                buttonAuth.addClass("d-flex justify-content-center btn btn-sm btn-primary")
                buttonAuth.text("Autorizar Projeto")               
            }
        }

        buttonAuth.append(iconAuth)

        const inputEnviar = document.createElement('input')
        inputEnviar.type = 'hidden'
        inputEnviar.value = id
        inputEnviar.name = 'id'

        const inputInstalador = document.createElement('input')
        inputInstalador.type = 'hidden'
        inputInstalador.value = id
        inputInstalador.name = 'id'

        listActions.html(actions)
        listInstallers.html(instalers)
        listModules.html(modules)
        addInstaller.append(inputInstalador)
        sendTeam.prepend(inputEnviar)
    }
</script>